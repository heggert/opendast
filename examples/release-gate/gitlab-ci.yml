# Release Gate — GitLab CI/CD
#
# Pattern:  Run a full DAST scan when a version tag (v*) is pushed.
#           Acts as a formal release approval checkpoint — the pipeline
#           is blocked if vulnerabilities are found.
#
# Trigger:  Tag push matching /^v/ (e.g., v1.0.0, v2.3.1-rc.1).
#
# Playbook: Default (playbooks/web_scan.md baked into the container image).
#
# Prerequisites:
#   1. CI/CD variable ANTHROPIC_API_KEY (Settings > CI/CD > Variables,
#      masked & protected).
#   2. Replace https://staging.example.com with your staging/RC URL.

stages:
  - deploy
  - dast

variables:
  OPENDAST_IMAGE: ghcr.io/heggert/opendast:latest
  TARGET_URL: https://staging.example.com
  TOKEN_LIMIT: "300000"

# Stub — replace with your actual release candidate deployment.
deploy-rc:
  stage: deploy
  script:
    - echo "Deploying $CI_COMMIT_TAG to staging..."
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/

dast-release-gate:
  stage: dast
  image: $OPENDAST_IMAGE
  needs: ["deploy-rc"]
  variables:
    ANTHROPIC_API_KEY: $ANTHROPIC_API_KEY
  script:
    - python main.py --target "$TARGET_URL" --token-limit "$TOKEN_LIMIT"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/
  allow_failure: false
